<h1 align="center" style="border-bottom: none">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
    <br>
    CKA Lesson 6: Managing Clusters
</h1>
<h3 align="center" style="border-bottom: none">
    Notes by: <a href="https://github.com/mx-ulises" target="_blank">Ulises Martinez</a>
</h3>
<hr />

<p align="center">
    Auto-generated by the <a href="https://github.com/WhitneyLampkin/devscriber" target="_blank">DevScriber</a> command-line tool.
</p>

<div align="center">

![GitHub language count](https://img.shields.io/github/languages/count/mx-ulises/certification-prep-cka-ckad?label=Languages)
![GitHub contributors](https://img.shields.io/github/contributors/mx-ulises/certification-prep-cka-ckad?label=Contributors&color=yellow)
![GitHub repo size](https://img.shields.io/github/repo-size/mx-ulises/certification-prep-cka-ckad?label=Repo%20Size&color=teal)
![GitHub repo file count (file type)](https://img.shields.io/github/directory-file-count/mx-ulises/certification-prep-cka-ckad?label=Files&color=purple)

</div>

## Introduction

In this lesson we will review several tasks to manage cluster nodes, such as analyzing cluster nodes, how to manage node containers with `crictl`, how to run static `Pod` and managing Node state and Node Services.

## Analyzing Cluster Nodes

Kubernetes cluster nodes run Linux processes. To monitor these proccess, generic Linux rules apply:
 - Use `systemctl status kubelet` to get runtime information about the kubelet
 - Logs are in `/var/log` as well as output of `journalctl -u kubelet`
 - Generic node information is obtained trough `kubectl describe node <nodeName>`
 - If metric server is installed, `kubectl top nodes` will provide a summary of CPU and memory usage on a node.

### ‚≠ê Managing Node Services

The container runtime (containerd) and kubelet are managed by the Linux systemd service manager. Use `system status kubelet` to check the current status of the kubelet. To manually start it, use `sudo systemctl start kubelet`. To manage pod use `crictl` instead of `ps` or other linux tools.

## Manage Node Containers

The tool `crictl` is used to manage containers. All pofs are started as containers in nodes. `crictl` is a generic tool that communicates to the container runtime to get information about running containers. As such, it replaces generic tools like docker or podman.

To use it, a runrime-endpoint and image-enpoint is needed. The most convenient way to do so is by defininf the `/etc/crictl.yaml` file on the nodes where you want to run `crictl`. Some commands includes:

| Command                | Description                                        |
|------------------------|----------------------------------------------------|
| `crictl ps`            | List all containers running in the system.         |
| `crictl pods`          | List all pods in the system.                       |
| `crictl inspect <name>`| Inspect a specific container by name.              |
| `crictl pull <image>`  | Pull a container image from a container registry.  |
| `crictl images`        | List all container images available in the system. |
| `crictl --help`        | Display help information about `crictl` commands.  |

## Running Static Pods

A static `Pod` is a `Pod` that is automatically picked by the kubelet. The kubelet systemd process is configured to run static `Pod` from the `/etc/kubernetes/manifest` directory. On the control node, static `Pod` are an essential part of how Kubernetes works: systemd starts kubelet, and kubelet starts core kubernetes services as static `Pod`.

Administrators can manually add static Pod if so desired, just copy a manifest file into the `/etc/kubernetes/manifest` directory and the kubelet proccess will pick it up.

To modify the path where kubelet picks picks up the static `Pod`, edit the `staticPodPath` in `/var/lib/kubelet/config.yaml` and use `sudo systemctl restart kubelet` to restart. Doing this in the control bode would be dangerous, and shouldn't be done.

## Managing Node State

Node state is used to do management in the cluster. Some useful commands for this are:

| Command                                       | Description                                                                                                    |
|-----------------------------------------------|----------------------------------------------------------------------------------------------------------------|
| `kubectl cordon <node>`                       | Marks the specified node as unschedulable, preventing new pods from being scheduled onto it.                   |
| `kubectl uncordon <node>`                     | Reverses the effect of `kubectl cordon`, allowing pods to be scheduled onto the specified node again.          |
| `kubectl drain <node>`                        | Evicts all non-daemonset pods from the specified node gracefully, ensuring that they are rescheduled onto other nodes first. |
| `kubectl drain <node> --ignore-daemonsets`    | Evicts all non-daemonset pods from the specified node gracefully.            |
| `kubectl drain <node> --delete-emptydir-data` | Evicts all pods from the specified node gracefully and deletes any emptyDir volumes associated with the pods.  |

While cordon or drain nodes, a taint is set to the node. On Drains, `Pod` managed by `Deployment` or `StatefulSet`, will be rescheduled in available nodes. In `DaemonSet` or individual `Pod`, those will not be rescheduled and they will be lost.

<p align="center" style="border-bottom: none; margin-top: 50px;">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
</p>
