<h1 align="center" style="border-bottom: none">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
    <br>
    CKA Lesson 10: Managing Security Settings
</h1>
<h3 align="center" style="border-bottom: none">
    Notes by: <a href="https://github.com/mx-ulises" target="_blank">Ulises Martinez</a>
</h3>
<hr />

<p align="center">
    Auto-generated by the <a href="https://github.com/WhitneyLampkin/devscriber" target="_blank">DevScriber</a> command-line tool.
</p>

<div align="center">

![GitHub language count](https://img.shields.io/github/languages/count/mx-ulises/certification-prep-cka-ckad?label=Languages)
![GitHub contributors](https://img.shields.io/github/contributors/mx-ulises/certification-prep-cka-ckad?label=Contributors&color=yellow)
![GitHub repo size](https://img.shields.io/github/repo-size/mx-ulises/certification-prep-cka-ckad?label=Repo%20Size&color=teal)
![GitHub repo file count (file type)](https://img.shields.io/github/directory-file-count/mx-ulises/certification-prep-cka-ckad?label=Files&color=purple)

</div>

## Introduction

In this lesson we will understand access to API access from security point of view. We will review the `SecurityContext`, what are `ServiceAccounts` and how they are configured to grant access to API resources, we will set-up `Roles` and `RoleBindings` to have Role Based Access Control (RBAC) and how to create kubernetes users.

## API Access

The `kube-apiserver` is the service that read and write the `etcd` database. To define wether someone can do or not in `kube-apiservice` we gave `Role` and `ClusterRole`. To access `kube-apiserver`, there are some ways:

 - We can do trought `kubectl` that is configured with the `.kube/config` files that has the certificates for an user.
 - We can do trought applications running in `Pod`. A `Pod` run with a `ServiceAccount` that has some permissions.

`User` and `ServiceAccount` has a `Role` that is configured via a `RoleBinding` or a `ClusterRoleBinding`.

### ⭐ Service Accounts

Kubernetes API doesn't define users for people to authenticate and authorize. There are some options:

 - Defined by X.509 certificates
 - Obtained from external OpenID-based authentication (Google, Active Directory, etc..)

The `ServiceAccount` are used as internal user accoutns that authorize `Pod` to get access to specific API resources. If no `ServiceAccount` is specified in the `Pod`, it would run the `default` service account. You can list `ServiceAccount` with `kubectl get serviceaccounts`. Some `ServiceAccount` are created along with the cluster to provide access to some internal services and plugins in their `Pod`.

In RBAC there are three fundamental pieces:

| Resource | Description |
|----------|--|
| `Role`   | Roles are utilized within a Namespace to assign permissions using verbs (e.g., `list`, `create`) for accessing specific resources (e.g., `Pod`, `Deployment`) or specifying resource names (specific `Pod` names). They are created using `kubectl create role`. |
| `RoleBinding`         | RoleBindings link users or `ServiceAccount` to a `Role`. They allow one `Role` to be bound to multiple subjects, which can be `ServiceAccount`, users, or groups. They are created using `kubectl create rolebinding`. |
| `ServiceAccount`      | ServiceAccounts are employed to authorize `Pod`s to access information from the API server. To grant access to a `ServiceAccount`, it needs to be connected to a `Role` using a `RoleBinding`. They are created using `kubectl create serviceaccount`. |

### ⭐ Cluster Roles and Cluster Role Binding

The `Role` has a `Namespace` scope, while `ClusterRole` apply to the entire cluster. They work similar to the `Role` resource. To provide access to `ClusterRoles` to an user or a `ServiceAccount`, it is done trhough `ClusterRoleBinding`.

### ⭐ Create User Accounts

Kubernetes doesn't have user objects. User accounts consit of a authorized certificate that is completed with some authorization as defined in RBAC. To create a user account, the following steps are needed:

 1. Create a public/private key pair, create a Certificate Signing Request and Sign the Certificate
 1. Create a configuration file that uses these keys to access the kubernetes cluster:
    ```
    kubectl config set-credentials <user> --client-certificate=<certificate.crt> --client-key=<key.key>
    ```
 1. Set and use default context for the new user:
    ```
    kubectl config set-context <userContextName> --cluster=kubernetes --namespace=<namespace> --user=<user>

    kubectl config use-context <userContextName>
    ```
 1. Create an RBAC `Role`
 1. Create an RBAC `RoleBinding` for the new user

## Security Context

`SecurityContext` defines rpivilege and access control settings for `Pod` and containers and can include the following:

 - UID and GID based discertionary access control
 - SELinux security labels
 - Linux Capabilities for advance access
 - AppArmor (Equivalent as SELinux)
 - Seccomp
 - The `AllowPrivilegeEscalation` settigns to have escalated priviledges
 - Run as not root with: `runAsNonRoot`

The `SecurityContext` can be set up at `Pod` level and a container level:

 - `kubectl explain pod.spec.securityContext`
 - `kubectl explain pod.spec.containers.securityContext`

Note that the options are not exactly the same. If settings are applied at the container level, settings at the `Pod` level could be overriden.

<p align="center" style="border-bottom: none; margin-top: 50px;">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
</p>
