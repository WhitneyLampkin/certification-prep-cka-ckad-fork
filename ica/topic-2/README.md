<h1 align="center" style="border-bottom: none">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
    <br>
    Istio Topic 2: Request Routing
</h1>
<h3 align="center" style="border-bottom: none">
    Notes by: <a href="https://github.com/mx-ulises" target="_blank">Ulises Martinez</a>
</h3>
<hr />

<p align="center">
    Auto-generated by the <a href="https://github.com/WhitneyLampkin/devscriber" target="_blank">DevScriber</a> command-line tool.
</p>

<div align="center">

![GitHub language count](https://img.shields.io/github/languages/count/mx-ulises/certification-prep-cka-ckad?label=Languages)
![GitHub contributors](https://img.shields.io/github/contributors/mx-ulises/certification-prep-cka-ckad?label=Contributors&color=yellow)
![GitHub repo size](https://img.shields.io/github/repo-size/mx-ulises/certification-prep-cka-ckad?label=Repo%20Size&color=teal)
![GitHub repo file count (file type)](https://img.shields.io/github/directory-file-count/mx-ulises/certification-prep-cka-ckad?label=Files&color=purple)

</div>

## Introduction

These notes cover the topic on how we can do Request Routing on services part of the Istio's service registry using `DestinationRule` and `VirtualService`. This enables things such as A/B testing and further features such as Traffic Shifting. Relevant documentations includes the following:

 * [Documentation](https://istio.io/latest/docs/) > [Tasks](https://istio.io/latest/docs/tasks/) > [Traffic Management](https://istio.io/latest/docs/tasks/traffic-management/) > [Request Routing](https://istio.io/latest/docs/tasks/traffic-management/request-routing/)
 * [Documentation](https://istio.io/latest/docs/) > [Reference](https://istio.io/latest/docs/reference/) > [Configuration](https://istio.io/latest/docs/reference/config/) > [Traffic Management](https://istio.io/latest/docs/reference/config/networking/) > [Destination Rule](https://istio.io/latest/docs/reference/config/networking/destination-rule/)
 * [Documentation](https://istio.io/latest/docs/) > [Reference](https://istio.io/latest/docs/reference/) > [Configuration](https://istio.io/latest/docs/reference/config/) > [Traffic Management](https://istio.io/latest/docs/reference/config/networking/) > [Virtual Service](https://istio.io/latest/docs/reference/config/networking/virtual-service/)


## Deploy Pre-Requisites

For this task, we will deploy two `Deployment` (`nginx-app-v1` and `nginx-app-v2`) that share same `app` label (`nginx-app`) and they have different `version` label (`v1` and `v2`). When we hit the port `80` on these deployments, this will display a message with the `Pod` name (that includes the version as well):

```
Welcome to: nginx-app-v1-55cbcdd84-dv4q4
```

Additionally, we create a `Service` with the selector `app=nginx-app`, meaning that the endpoints are all `Pod` in both deployments.

All these resources are created in a the `traffic-routing` namespace that is created as well by this spec.

Apply the file [nginx-app.yaml](nginx-app.yaml) to deploy all the resources:

```
kubectl apply -f nginx-app.yaml
```

You should see following resources:

```
kubectl get all -n traffic-routing

NAME                                READY   STATUS    RESTARTS   AGE
pod/nginx-app-v1-55cbcdd84-dv4q4    2/2     Running   0          26m
pod/nginx-app-v2-5b557788b7-nv9sb   2/2     Running   0          26m

NAME                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/nginx-app   ClusterIP   10.96.65.168   <none>        80/TCP    26m

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx-app-v1   1/1     1            1           26m
deployment.apps/nginx-app-v2   1/1     1            1           26m

NAME                                      DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-app-v1-55cbcdd84    1         1         1       26m
replicaset.apps/nginx-app-v2-5b557788b7   1         1         1       26m
```

## Accessing the Service

You can access your service from another Pod. For this purpose, we create an auxiliar sleep nginx Pod:

```
kubectl run sleep --image=nginx -n traffic-routing -- sleep 3600
```

And then you can run curl on it. Run it several times so you can see how sometimes it picks a different node from a different deployment

```
kubectl exec sleep -c sleep -n traffic-routing -- curl nginx-app 2> /dev/null
# Welcome to: nginx-app-v1-55cbcdd84-dv4q4


kubectl exec sleep -c sleep -n traffic-routing -- curl nginx-app 2> /dev/null
# Welcome to: nginx-app-v2-5b557788b7-nv9sb
```

## Defining `DestinationRule` with subsets

A `DestinationRule` is a resource that help to configure policies once traffic arrived to the service. Different configurations can be added here such as Load Balancing policies. In this case we are adding a rule to define `subsets` in the destination based on the labels of the `Pod` selected by the service.

In the file [nginx-app-dr.yaml](nginx-app-dr) we are indicating that the `nginx-app` service we previously created will have two subsets:
 * `v1` that will select the `Pod` with label `version=v1`
 * `v2` that will select the `Pod` with label `version=v2`

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: nginx-app-dr
  namespace: traffic-routing
spec:
  host: nginx-app
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

As we apply this policy, we won't have any effect yet in the routing as we are just defining names for groups of `Pod` that the `Service` can recognize, but these `subsets` can be used later by the `VirtualService` to route the requests.

```
kubectl apply -f nginx-app-dr.yaml
```

## Defining `VirtualService` to route requests

Traffic routing configurations happens here. As an intermediate step, we can create following `VirtualService` that will default all traffic comming to `nginx-app` to the `Pod` in subset `v1` of service `nginx-app`. This definiton is in file [nginx-app-vs-only-v1.yaml](nginx-app-vs-only-v1.yaml):

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: nginx-app-vs
  namespace: traffic-routing
spec:
  hosts:
  - nginx-app
  http:
  - route:
    - destination:
        host: nginx-app
        subset: v1
```

This will prevent any traffic to go to the deployment `nginx-app-v2`:

```
kubectl apply -f nginx-app-vs-only-v1.yaml

# Any curl would go to nginx-app-v1
kubectl exec sleep -c sleep -n traffic-routing -- curl nginx-app 2> /dev/null
# Welcome to: nginx-app-v1-55cbcdd84-dv4q4
```

Now we want to catch traffic that meets specific conditions to a different subset in `nginx-app`. In this case, we want to capture when we have a header in the request that specifies we want to route to `v2` (this `route-to-v2: true`). This definiton is in file [nginx-app-vs.yaml](nginx-app-vs.yaml):

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: nginx-app-vs
  namespace: traffic-routing
spec:
  hosts:
  - nginx-app
  http:
  - match:
    - headers:
        route-to-v2:
          exact: "true"
    route:
    - destination:
        host: nginx-app
        subset: v2
  - route:
    - destination:
        host: nginx-app
        subset: v1
```

As we can see in this definition, it has a matching rule on headers, looking for a header with name `route-to-v2` and value `true`, and it will set a destination to this match on service `nginx-app` with subset `v2`. Now, all requests with hea

```
kubectl apply -f nginx-app-vs.yaml

# Requests without the header will default to v1
kubectl exec sleep -c sleep -n traffic-routing -- curl nginx-app -v 2>/dev/null
# Welcome to: nginx-app-v1-55cbcdd84-dv4q4

# Requests with the header and the right value will match to v2
kubectl exec sleep -c sleep -n traffic-routing -- curl nginx-app -H "route-to-v2: true" -v 2>/dev/null
# Welcome to: nginx-app-v2-5b557788b7-nv9sb

# Requests with the header but different value will default to v1
kubectl exec sleep -c sleep -n traffic-routing -- curl nginx-app -H "route-to-v2: invalid" -v 2>/dev/null
# Welcome to: nginx-app-v1-55cbcdd84-dv4q4
```

<p align="center" style="border-bottom: none; margin-top: 50px;">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
</p>
