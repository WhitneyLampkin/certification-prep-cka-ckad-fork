<h1 align="center" style="border-bottom: none">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
    <br>
    Istio Topic 6: Circuit Breaking
</h1>
<h3 align="center" style="border-bottom: none">
    Notes by: <a href="https://github.com/mx-ulises" target="_blank">Ulises Martinez</a>
</h3>
<hr />

<p align="center">
    Auto-generated by the <a href="https://github.com/WhitneyLampkin/devscriber" target="_blank">DevScriber</a> command-line tool.
</p>

<div align="center">

![GitHub language count](https://img.shields.io/github/languages/count/mx-ulises/certification-prep-cka-ckad?label=Languages)
![GitHub contributors](https://img.shields.io/github/contributors/mx-ulises/certification-prep-cka-ckad?label=Contributors&color=yellow)
![GitHub repo size](https://img.shields.io/github/repo-size/mx-ulises/certification-prep-cka-ckad?label=Repo%20Size&color=teal)
![GitHub repo file count (file type)](https://img.shields.io/github/directory-file-count/mx-ulises/certification-prep-cka-ckad?label=Files&color=purple)

</div>

## Introduction

These notes cover the topic on how we can do circuit breaking for connections, requests and outlier detection using `DestinationRule`. This allow you to limit the impact of failures, latency spikes and other undesirable effects of network applications.

 * [Documentation](https://istio.io/latest/docs/) > [Tasks](https://istio.io/latest/docs/tasks/) > [Traffic Management](https://istio.io/latest/docs/tasks/traffic-management/) > [Circuit Breaking](https://istio.io/latest/docs/tasks/traffic-management/circuit-breaking/)
 * [Documentation](https://istio.io/latest/docs/) > [Reference](https://istio.io/latest/docs/reference/) > [Configuration](https://istio.io/latest/docs/reference/config/) > [Traffic Management](https://istio.io/latest/docs/reference/config/networking/) > [Destination Rule](https://istio.io/latest/docs/reference/config/networking/destination-rule/)

## Deploy Pre-Requisites

For this task, we will deploy a `Deployment` (`nginx-app-v1`) that has the `app` label (`nginx-app`) and the `version` label (`v1`). Additionally, we create a `Service` with the selector `app=nginx-app`, meaning that the endpoints are all `Pod` in the deployment. When we hit the port `80` on these deployments, this will display a message with the `Pod` name (that includes the version as well).

```
Welcome to: nginx-app-v1-55cbcdd84-cxmgr
```

We also create a `Pod` and a `Service` for fortio that will allow us to test the circuit breaking.

All these resources are created in a the `circuit-breaking` namespace that is created as well by this spec.

Apply the files [nginx-app.yaml](nginx-app.yaml) and [fortio.yaml](fortio.yaml) to deploy all the resources:

```
kubectl apply -f nginx-app.yaml
kubectl apply -f fortio.yaml
```

You should see following resources:

```
kubectl get all -n circuit-breaking

NAME                                 READY   STATUS    RESTARTS   AGE
pod/fortio-deploy-5669d4866b-xj2sm   2/2     Running   0          7s
pod/nginx-app-v1-55cbcdd84-n429f     2/2     Running   0          13s

NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/fortio      ClusterIP   10.96.251.123   <none>        8080/TCP   7s
service/nginx-app   ClusterIP   10.96.187.59    <none>        80/TCP     13s

NAME                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/fortio-deploy   1/1     1            1           7s
deployment.apps/nginx-app-v1    1/1     1            1           13s

NAME                                       DESIRED   CURRENT   READY   AGE
replicaset.apps/fortio-deploy-5669d4866b   1         1         1       7s
replicaset.apps/nginx-app-v1-55cbcdd84     1         1         1       13s
```

## Defining `DestinationRule` with subsets

A `DestinationRule` is a resource that help to configure policies once traffic arrived to the service. Different configurations can be added here such as Load Balancing policies. In this case we are adding configurations to limit maximum number of connections that are allowed in our service set to 1. We also add the configuration to set outlier detection after one consecutive 5xx errors, with ejection time of 3 minutes. This is the configuration in the file [nginx-app-dr.yaml](nginx-app-dr):

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: nginx-app-dr
  namespace: circuit-breaking
spec:
  host: nginx-app
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 1
      http:
        http1MaxPendingRequests: 1
        maxRequestsPerConnection: 1
    outlierDetection:
      consecutive5xxErrors: 1
      interval: 1s
      baseEjectionTime: 3m
      maxEjectionPercent: 100
```

After we apply this policy, we can start doing some loading testing with fortio to check our configuration.

```
kubectl apply -f nginx-app-dr.yaml
```

First, we try a single request:

```
# Get fortio Pod name:
export FORTIO_POD=$(kubectl -n circuit-breaking get pods -l app=fortio -o 'jsonpath={.items[0].metadata.name}')

# Run single request to nginx-app service
kubectl -n circuit-breaking exec "$FORTIO_POD" -c fortio -- /usr/bin/fortio curl -quiet http://nginx-app

  # HTTP/1.1 200 OK
  # server: envoy
  # date: Fri, 12 Apr 2024 05:17:21 GMT
  # content-type: text/html
  # content-length: 41
  # last-modified: Fri, 12 Apr 2024 05:12:24 GMT
  # etag: "6618c2b8-29"
  # accept-ranges: bytes
  # x-envoy-upstream-service-time: 8

  # Welcome to: nginx-app-v1-55cbcdd84-n429f
```

As we can see, it can handle properly one single request, now we are going to try 2 connections sending 20 requests and observe how our service behave:

```
kubectl -n circuit-breaking exec "$FORTIO_POD" -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning http://nginx-app

  # ...
  # IP addresses distribution:
  # 10.96.187.59:80: 11
  # Code 200 : 11 (55.0 %)
  # Code 503 : 9 (45.0 %)
  # ...
```

As we can see, most of the requests succeded, but many of them (45%) failed and were circuit broken to prevent more failures.

<p align="center" style="border-bottom: none; margin-top: 50px;">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
</p>
