<h1 align="center" style="border-bottom: none">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
    <br>
    Istio Topic 5: Traffic Mirroring
</h1>
<h3 align="center" style="border-bottom: none">
    Notes by: <a href="https://github.com/mx-ulises" target="_blank">Ulises Martinez</a>
</h3>
<hr />

<p align="center">
    Auto-generated by the <a href="https://github.com/WhitneyLampkin/devscriber" target="_blank">DevScriber</a> command-line tool.
</p>

<div align="center">

![GitHub language count](https://img.shields.io/github/languages/count/mx-ulises/certification-prep-cka-ckad?label=Languages)
![GitHub contributors](https://img.shields.io/github/contributors/mx-ulises/certification-prep-cka-ckad?label=Contributors&color=yellow)
![GitHub repo size](https://img.shields.io/github/repo-size/mx-ulises/certification-prep-cka-ckad?label=Repo%20Size&color=teal)
![GitHub repo file count (file type)](https://img.shields.io/github/directory-file-count/mx-ulises/certification-prep-cka-ckad?label=Files&color=purple)

</div>

## Introduction

These notes cover the topic on how we can do traffic shifting on different versions/subsets of services part of the Istio's service registry using `DestinationRule` and `VirtualService`. This allow routing traffic to different versions of the application for rollouts or A/B testing. Relevant documentations includes the following:

 * [Documentation](https://istio.io/latest/docs/) > [Tasks](https://istio.io/latest/docs/tasks/) > [Traffic Management](https://istio.io/latest/docs/tasks/traffic-management/) > [Mirroring](https://istio.io/latest/docs/tasks/traffic-management/mirroring/)
 * [Documentation](https://istio.io/latest/docs/) > [Reference](https://istio.io/latest/docs/reference/) > [Configuration](https://istio.io/latest/docs/reference/config/) > [Traffic Management](https://istio.io/latest/docs/reference/config/networking/) > [Destination Rule](https://istio.io/latest/docs/reference/config/networking/destination-rule/)
 * [Documentation](https://istio.io/latest/docs/) > [Reference](https://istio.io/latest/docs/reference/) > [Configuration](https://istio.io/latest/docs/reference/config/) > [Traffic Management](https://istio.io/latest/docs/reference/config/networking/) > [Virtual Service](https://istio.io/latest/docs/reference/config/networking/virtual-service/)


## Deploy Pre-Requisites

For this task, we will deploy a `Deployment` (`nginx-app-v1`) that has the `app` label (`nginx-app`) and the `version` label (`v1` and `v2`). When we hit the port `80` on these deployments, this will display a message with the `Pod` name (that includes the version as well):

```
Welcome to: nginx-app-v1-55cbcdd84-cxmgr
```

Additionally, we create a `Service` with the selector `app=nginx-app`, meaning that the endpoints are all `Pod` in the deployment.

All these resources are created in a the `traffic-mirroring` namespace that is created as well by this spec.

Apply the file [nginx-app.yaml](nginx-app.yaml) to deploy all the resources:

```
kubectl apply -f nginx-app.yaml
```

You should see following resources:

```
kubectl get all -n traffic-mirroring

NAME                                READY   STATUS    RESTARTS   AGE
pod/nginx-app-v1-55cbcdd84-cxmgr    2/2     Running   0          43s
pod/nginx-app-v2-5b557788b7-8plpr   2/2     Running   0          43s

NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/nginx-app   ClusterIP   10.96.228.174   <none>        80/TCP    43s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx-app-v1   1/1     1            1           43s
deployment.apps/nginx-app-v2   1/1     1            1           43s

NAME                                      DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-app-v1-55cbcdd84    1         1         1       43s
replicaset.apps/nginx-app-v2-5b557788b7   1         1         1       43s
```

## Accessing the Service

You can access your service from another Pod. For this purpose, we create an auxiliar sleep nginx Pod:

```
kubectl run sleep --image=nginx -n traffic-mirroring -- sleep 3600
```

And then you can run curl on it:

```
kubectl exec sleep -c sleep -n traffic-mirroring -- curl nginx-app 2> /dev/null
# Welcome to: nginx-app-v1-55cbcdd84-cxmgr
```

We can see the logs with the requests that happen in each of the `Pod` by running following commands:

```
# Get the name of the nginix Pods

export V1_POD=$(kubectl get pod -l app=nginx-app,version=v1 -n traffic-mirroring -o jsonpath={.items..metadata.name})
export V2_POD=$(kubectl get pod -l app=nginx-app,version=v2 -n traffic-mirroring -o jsonpath={.items..metadata.name})

# Get Logs of each of the Pods

kubectl logs $V1_POD -c nginx-app -n traffic-mirroring
  # ...
  # 2024/04/11 21:56:35 [notice] 1#1: start worker process 35
  # 127.0.0.6 - - [11/Apr/2024:21:57:51 +0000] "GET / HTTP/1.1" 200 41 "-" "curl/7.88.1" "-"

kubectl logs $V2_POD -c nginx-app -n traffic-mirroring
  # ...
  # 2024/04/11 21:56:36 [notice] 1#1: start worker process 35
  # No requests yet
```

## Defining `DestinationRule` with subsets

A `DestinationRule` is a resource that help to configure policies once traffic arrived to the service. Different configurations can be added here such as Load Balancing policies. In this case we are adding a rule to define `subsets` in the destination based on the labels of the `Pod` selected by the service.

In the file [nginx-app-dr.yaml](nginx-app-dr) we are indicating that the `nginx-app` service we previously created will have two subsets:
 * `v1` that will select the `Pod` with label `version=v1`
 * `v2` that will select the `Pod` with label `version=v2`

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: nginx-app-dr
  namespace: traffic-mirroring
spec:
  host: nginx-app
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

As we apply this policy, we won't have any effect yet in the routing as we are just defining names for groups of `Pod` that the `Service` can recognize, but these `subsets` can be used later by the `VirtualService` to route the requests.

```
kubectl apply -f nginx-app-dr.yaml
```

## Defining `VirtualService` to inject Delay

Traffic mirroring configurations happens here. We create the following `VirtualService` that will default all traffic comming to `nginx-app` to the `Pod` in subset `v1` of the service `nginx-app`. This definition is in file [nginx-app-vs-no-traffic-mirroring.yaml](nginx-app-vs-no-traffic-mirroring.yaml):

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: nginx-app-vs
  namespace: traffic-mirroring
spec:
  hosts:
  - nginx-app
  http:
  - route:
    - destination:
        host: nginx-app
        subset: v1
```

We can apply and test our service is recieving some requests, we check logs in both `v1` and `v2`:

```
# Deploy the VirtualService with fault injection
kubectl apply -f nginx-app-vs-no-traffic-mirroring.yaml

# Make some requests
kubectl exec sleep -c sleep -n traffic-mirroring -- curl nginx-app 2> /dev/null
Welcome to: nginx-app-v1-55cbcdd84-cxmgr

# Check logs in both versions
kubectl logs $V1_POD -c nginx-app -n traffic-mirroring
  # ...
  # 127.0.0.6 - - [11/Apr/2024:21:57:51 +0000] "GET / HTTP/1.1" 200 41 "-" "curl/7.88.1" "-"
  # 127.0.0.6 - - [11/Apr/2024:22:06:00 +0000] "GET / HTTP/1.1" 200 41 "-" "curl/7.88.1" "-"

kubectl logs $V2_POD -c nginx-app -n traffic-mirroring
  # ...
  # No requests
```

As we can see, we are only getting the requests landing on `v1` but not on `v2`. Now we can apply traffic mirroring configurations to our `VirtualService` to recieve requests in both versions. We are setting here `nginx-app` with subset `v2` as the mirror destination in 100% of the traffic. This definiton is in file [nginx-app-vs-traffic-mirroring.yaml](nginx-app-vs-traffic-mirroring.yaml):

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: nginx-app-vs
  namespace: traffic-mirroring
spec:
  hosts:
  - nginx-app
  http:
  - route:
    - destination:
        host: nginx-app
        subset: v1
    mirror:
      host: nginx-app
      subset: v2
    mirrorPercentage:
      value: 100.0
```

We can apply and test our service is recieving some requests, we check logs in both `v1` and `v2`:

```
# Deploy the VirtualService with fault injection
kubectl apply -f nginx-app-vs-traffic-mirroring.yaml

# Make some requests
kubectl exec sleep -c sleep -n traffic-mirroring -- curl nginx-app 2> /dev/null
Welcome to: nginx-app-v1-55cbcdd84-cxmgr

# Check logs in both versions
kubectl logs $V1_POD -c nginx-app -n traffic-mirroring
  # ...
  # 127.0.0.6 - - [11/Apr/2024:21:57:51 +0000] "GET / HTTP/1.1" 200 41 "-" "curl/7.88.1" "-"
  # 127.0.0.6 - - [11/Apr/2024:22:06:00 +0000] "GET / HTTP/1.1" 200 41 "-" "curl/7.88.1" "-"
  # 127.0.0.6 - - [11/Apr/2024:22:18:07 +0000] "GET / HTTP/1.1" 200 41 "-" "curl/7.88.1" "-"
  # 127.0.0.6 - - [11/Apr/2024:22:18:12 +0000] "GET / HTTP/1.1" 200 41 "-" "curl/7.88.1" "-"

kubectl logs $V2_POD -c nginx-app -n traffic-mirroring
  # ...
  # 127.0.0.6 - - [11/Apr/2024:22:18:07 +0000] "GET / HTTP/1.1" 200 42 "-" "curl/7.88.1" "10.244.0.41"
  # 127.0.0.6 - - [11/Apr/2024:22:18:12 +0000] "GET / HTTP/1.1" 200 42 "-" "curl/7.88.1" "10.244.0.41"
```

Here we can observe that we are recieving traffic in both versions. Just note that response is only recieved for `v1`.

<p align="center" style="border-bottom: none; margin-top: 50px;">
    <a href="https://github.com/mx-ulises/certification-prep-cka-ckad" target="_blank">
        <img alt="" src="https://github.com/mx-ulises/certification-prep-cka-ckad/blob/main/assets/notes-logo.png?raw=true" style="border-radius: 50%; height: 100px;">
    </a>
</p>
